rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is board owner
    function isBoardOwner(boardId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/boards/$(boardId)).data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user is board member
    function isBoardMember(boardId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/boards/$(boardId)/members/$(request.auth.uid));
    }
    
    // Helper function to check if user can edit board
    function canEditBoard(boardId) {
      return isAuthenticated() && (
        isBoardOwner(boardId) ||
        (isBoardMember(boardId) && 
         get(/databases/$(database)/documents/boards/$(boardId)/members/$(request.auth.uid)).data.role == 'edit') ||
        get(/databases/$(database)/documents/boards/$(boardId)).data.publicAccess == 'edit'
      );
    }
    
    // Helper: board allows public view (any authenticated user can read)
    function isPublicView(boardId) {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/boards/$(boardId)).data.publicAccess == 'view' ||
              get(/databases/$(database)/documents/boards/$(boardId)).data.publicAccess == 'edit');
    }
    
    // Collection group rule for invites - required for querying across all boards
    match /{path=**}/invites/{inviteId} {
      allow read: if isAuthenticated();
    }

    // Collection group rule for members - required for "shared boards" query
    // Query filters by userId so client only receives own memberships
    match /{path=**}/members/{memberId} {
      allow read: if isAuthenticated();
    }

    // Boards collection
    // Read: owner, member, public, or any authenticated (permissive for compatibility)
    match /boards/{boardId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isBoardOwner(boardId);
      
      // Board members
      // Allow read if: (a) user is member of this board, or (b) user is reading their own
      // membership doc (memberId == their uid) - needed for collection group query
      // Allow create: owner can add anyone; user can add themselves (for invite accept flow)
      match /members/{memberId} {
        allow read: if isBoardMember(boardId) || (isAuthenticated() && request.auth.uid == memberId);
        allow create: if isBoardOwner(boardId) || (isAuthenticated() && request.auth.uid == memberId);
        allow update, delete: if isBoardOwner(boardId);
      }
      
      // Board invites
      match /invites/{inviteId} {
        allow read: if isAuthenticated();
        allow create: if isBoardOwner(boardId);
        // Invitee can update (accept/reject). Allow when: email matches, or owner, or pending
        // (pending allows accept - client validates email; token email may differ in case)
        allow update: if isAuthenticated() && (
          resource.data.email == request.auth.token.email ||
          isBoardOwner(boardId) ||
          resource.data.status == 'pending'
        );
        allow delete: if isBoardOwner(boardId);
      }
      
      // Board objects - permissive read for compatibility; write: canEdit (includes public edit)
      match /objects/{objectId} {
        allow read: if isAuthenticated();
        allow write: if canEditBoard(boardId);
      }

      // Board comments - permissive read for compatibility
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create, update: if canEditBoard(boardId);
        allow delete: if canEditBoard(boardId) && resource.data.authorId == request.auth.uid;
      }
    }
  }
}
